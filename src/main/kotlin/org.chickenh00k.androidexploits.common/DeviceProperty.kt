package org.chickenh00k.androidexploits.common

import kotlinx.serialization.Serializable
import org.chickenh00k.androidexploits.common.Tags.INSTALLERS_TAG
import org.chickenh00k.androidexploits.common.Tags.SECURITY_PATCH_TAG
import org.json.JSONObject
import java.text.SimpleDateFormat


@Serializable
data class DeviceProperty(val key: String, val value: String) {

    companion object {

        fun getSecurityPatchDate(properties: List<DeviceProperty>): kotlinx.datetime.Instant? {
            val securityPatchRaw = properties.find { it.key ==  SECURITY_PATCH_TAG}
            if(securityPatchRaw == null) {
                return null
            }
            val formatter = SimpleDateFormat("yyyy-MM-dd")
            val patchDate = formatter.parse(securityPatchRaw.value)
            return kotlinx.datetime.Instant.fromEpochMilliseconds(patchDate.time)
        }

        fun getInstallers(propperties: List<DeviceProperty>):  HashMap<String, ArrayList<String>>? {
            val installersMap = HashMap<String, ArrayList<String>>()
            val installer = propperties.find { it.key == INSTALLERS_TAG }
            installer?.let {
                val installerJson = JSONObject(it.value)
                val installerArray = installerJson.getJSONArray("installer")
                val length = installerArray.length()
                for(i in 0 until length) {
                    val jsonObject = installerArray.getJSONObject(i)
                    val installer = jsonObject.getString("installer")
                    val appPackage = jsonObject.getString("package")
                    installersMap.getOrPut(installer) { ArrayList() }.add(appPackage)
                }
                return installersMap
            }

            return null
        }

    }
}